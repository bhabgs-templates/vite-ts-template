!function(k,S,O){"use strict";var I="ht",c=k[I],R=c.Default,D=R.def,f=R.getInternal();c.HistoryManager=function(s){this._histories=[],this.setDataModel(s)},D(c.HistoryManager,S,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var S=this;S._betweenTransaction++,1===S._betweenTransaction&&(S._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var d=this,r=d._histories;if(d._betweenTransaction>0&&d._betweenTransaction--,0===d._betweenTransaction){if(d._transactionHistories){var E=[];for(var q in d._transactionHistories)E.push(d._transactionHistories[q]);E.length&&(r=r.slice(0,d._historyIndex+1),r.push(E),r.length>d._maxHistoryCount&&(r=r.slice(r.length-d._maxHistoryCount)),d.setHistories(r),d.setHistoryIndex(r.length-1,!0))}delete d._transactionHistories}}},setDataModel:function(K){var G=this,z=G._dataModel;z!==K&&(z&&(delete z._historyManager,z.ump(G.handleDataModelPropertyChange,G),z.umm(G.$5p,G),z.umd(G.$6p,G),z.removeHierarchyChangeListener(G.handleHierarchyChange,G),z.removeIndexChangeListener(G.handleIndexChange,G)),G._dataModel=K,K&&(K._historyManager=G,K.mp(G.handleDataModelPropertyChange,G),K.mm(G.$5p,G),K.md(G.$6p,G),K.addHierarchyChangeListener(G.handleHierarchyChange,G),K.addIndexChangeListener(G.handleIndexChange,G)),G.fp("dataModel",z,K),G.clear())},setHistoryIndex:function(a,i){var R=this,Q=R._historyIndex,$=R._histories.length;if(-1>a?a=-1:a>=$&&(a=$-1),Q!==a){if(!i){var S=a-Q;S>0?R.$2p(S):0>S&&R.$1p(-S)}R._historyIndex=a,R.fp("historyIndex",Q,a),R.dataModel&&R.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(h){var n=this,o=n._histories,A=n._maxHistoryCount;(!h||0>=h)&&(h=10),A!==h&&(n._maxHistoryCount=h,n.fp("maxHistoryCount",A,h),o.length>h&&n.clear())},cloneValue:function(z){return c.Default.clone(z)},isPropertyUndoable:function(W){return W&&!this.ignoredPropertyMap[W]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(x){return x&&!this.ignoreDataModelPropertyMap[x]},$5p:function(Y){this.handleChange(Y,Y.kind)},$6p:function(r){this.handleChange(r,"property")},handleHierarchyChange:function(c){this.handleChange(c,"hierarchy")},handleIndexChange:function(G){this.handleChange(G,"index")},handleDataModelPropertyChange:function(K){this.handleChange(K,"dataModelProperty")},toChildrenInfo:function(q){var r={};return r.data=q,r.children=[],q.eachChild(function(K){r.children.push(this.toChildrenInfo(K))},this),r},restoreChildren:function(Q){var y=Q.data;Q.children.forEach(function(w){var I=w.data;I.getParent()!==y&&y.addChild(I),this._dataModel.contains(I)||this._dataModel.add(I),this.restoreChildren(w)},this)},handleChange:function(G,v){var j=this;if(!(j._disabled||j._isUndoRedoing||R.loadingRefGraph)){var P,x=(j._histories,G.data),y=G.property;if(!x||!(x._refGraph||x instanceof c.RefGraph)){if("property"===v)j.isPropertyUndoable(y,x)&&(P={kind:v,data:x,property:y,oldValue:j.cloneValue(G.oldValue,x,y),newValue:j.cloneValue(G.newValue,x,y),event:G});else if("hierarchy"===v||"index"===v&&j.isIndexUndoable(G))P={kind:v,data:x,oldIndex:G.oldIndex,newIndex:G.newIndex,event:G};else if("clear"===v)P={kind:v,json:G.json,event:G};else if("add"===v){if(P={kind:v,data:x,event:G,childrenInfo:this.toChildrenInfo(x),parent:x.getParent()},P.parent){var F=j._dataModel.getSiblings(x);P.siblingsIndex=F.indexOf(x)}x instanceof c.Node&&(P.host=x.getHost(),P.attaches=x.getAttaches()?x.getAttaches().toArray():O),x instanceof c.Edge&&(P.source=x.getSource(),P.target=x.getTarget())}else"remove"===v?P={kind:v,data:x,event:G}:"dataModelProperty"===v&&j.isDataModelPropertyUndoable(y,x)&&(P={kind:v,property:y,oldValue:j.cloneValue(G.oldValue,x,y),newValue:j.cloneValue(G.newValue,x,y),event:G});j.addHistory(P)}}},addHistory:function(o){var y=this;if(o)if(y._betweenTransaction){var c=(o.data?o.data._id:0)+"_"+o.kind+"_"+o.property;if("property"===o.kind||"dataModelProperty"===o.kind){var n=y._transactionHistories[c];n&&(o.oldValue=n.oldValue)}y._transactionHistories[c]=o}else{var $=y._histories;$=$.slice(0,y._historyIndex+1),$.push([o]),$.length>y._maxHistoryCount&&($=$.slice($.length-y._maxHistoryCount)),y.setHistories($),y.setHistoryIndex($.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(B){(!B||0>=B)&&(B=1),this.setHistoryIndex(this._historyIndex-B)},$1p:function(p){if(this.canUndo()){var P,K=this,q=K._dataModel,x=K._histories,M=K._historyIndex,z=0;for(K._isUndoRedoing=!0,R.setIsolating(!0);p>0;){if(M>=0&&M<x.length){z++,P=x[M],M--;for(var N=P.length-1;N>=0;N--){var l=P[N],y=l.kind,c=l.data,O=l.property,h=l.event,g=this.cloneValue(l.oldValue,c,O);if(l.undo)l.undo();else if("add"===y)q.remove(c,{keepChildren:!0});else if("remove"===y)q.contains(c)||q.add(c,h.rootsIndex,h.datasIndex);else if("clear"===y)q.deserialize(R.clone(l.json));else if("property"===y)if("parent"===O)g?g.addChild(c,h.oldIndex):(c.setParent(g),h.oldIndex>=0&&q.moveTo(c,h.oldIndex));else{var J=null;0===O.indexOf("a:")?(J="attr",O=O.replace("a:","")):0===O.indexOf("s:")?(J="style",O=O.replace("s:","")):0===O.indexOf("f:")&&(J="field",O=O.replace("f:","")),f.setPropertyValue(c,J,O,g)}else if("dataModelProperty"===y){var J=null;0===O.indexOf("a:")?(J="attr",O=O.replace("a:","")):0===O.indexOf("s:")?(J="style",O=O.replace("s:","")):0===O.indexOf("f:")&&(J="field",O=O.replace("f:","")),f.setPropertyValue(q,J,O,g)}else"hierarchy"===y?q.moveTo(c,l.oldIndex):"index"===y&&q.moveToIndex(c,l.oldIndex)}}p--}R.setIsolating(!1),delete K._isUndoRedoing,K.afterUndo(z)}},afterUndo:function(){},redo:function(x){(!x||0>=x)&&(x=1),this.setHistoryIndex(this._historyIndex+x)},$2p:function(D){if(this.canRedo()){var W,O=this,H=O._dataModel,m=O._histories,t=O._historyIndex,y=0;for(O._isUndoRedoing=!0,R.setIsolating(!0);D>0;){if(t>=-1&&t<m.length-1){y++,t++,W=m[t];for(var T=0;T<W.length;T++){var N=W[T],S=N.kind,g=N.data,r=N.property,M=N.event,k=this.cloneValue(N.newValue,g,r);if(N.redo)N.redo();else if("add"===S)N.parent&&!g.getParent()&&N.parent.addChild(g,N.siblingsIndex),H.contains(g)||H.add(g,M.rootsIndex,M.datasIndex),this.restoreChildren(N.childrenInfo),g instanceof c.Node&&(g.setHost(N.host),N.attaches&&N.attaches.forEach(function(G){G.setHost(g)})),g instanceof c.Edge&&(g.setSource(N.source),g.setTarget(N.target));else if("remove"===S)H.remove(g);else if("clear"===S)H.clear();else if("property"===S)if("parent"===r)k?k.addChild(g,M.newIndex):(g.setParent(k),M.newIndex>=0&&H.moveTo(g,M.newIndex));else{var a=null;0===r.indexOf("a:")?(a="attr",r=r.replace("a:","")):0===r.indexOf("s:")?(a="style",r=r.replace("s:","")):0===r.indexOf("f:")&&(a="field",r=r.replace("f:","")),f.setPropertyValue(g,a,r,k)}else if("dataModelProperty"===S){var a=null;0===r.indexOf("a:")?(a="attr",r=r.replace("a:","")):0===r.indexOf("s:")?(a="style",r=r.replace("s:","")):0===r.indexOf("f:")&&(a="field",r=r.replace("f:","")),f.setPropertyValue(H,a,r,k)}else"hierarchy"===S?H.moveTo(g,N.newIndex):"index"===S&&H.moveToIndex(g,N.newIndex)}}D--}R.setIsolating(!1),delete O._isUndoRedoing,this.afterRedo(y)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);